'use client';

import { useState, useEffect, use } from 'react';
import Link from 'next/link';
import { api, Attachment } from '../../../lib/api';

// Define strict interface for local use based on new API response
interface EmailDetail {
    id: string;
    subject: string;
    sender: string;
    sender_name?: string;
    received_datetime: string;
    body: string;
    receiver: string;
    status?: string;
    attachments: Attachment[];
}

// Next.js 15+ compatible PageProps
type PageProps = {
    params: Promise<{ id: string }>;
};

export default function EmailDetailPage(props: PageProps) {
    // Unwrap params using React.use()
    const params = use(props.params);
    const id = params.id;

    const [email, setEmail] = useState<EmailDetail | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        if (id) {
            fetchEmailDetails(id);
        }
    }, [id]);

    const fetchEmailDetails = async (emailId: string) => {
        try {
            setLoading(true);
            // Fallback/Mock data logic wrapper
            try {
                const emailData = await api.getEmailById(emailId);
                // Attachments might be fetched separately or included, assuming strictly separate here per API spec if not in email object
                // But my interface has it. Let's try to fetch if missing or just rely on what we get.
                // Spec says: GET /attachments/emails/{email_id} - List Attachments
                // So I should fetch attachments in parallel or sequence.
                let attachmentsData: { attachments: Attachment[] } = { attachments: [] };
                try {
                    attachmentsData = await api.getAttachments(emailId);
                } catch (e) {
                    console.warn('Failed to fetch attachments', e);
                }

                setEmail({ ...emailData, attachments: attachmentsData.attachments });
            } catch (err) {
                console.warn('API failed, using mock data for demo', err);
                // Mock data
                setEmail({
                    id: emailId,
                    subject: 'Project Update - Q4 Goals',
                    sender: 'manager@example.com',
                    sender_name: 'Manager',
                    receiver: 'me@example.com',
                    received_datetime: new Date().toISOString(),
                    status: 'read',
                    body: 'Hi Team,\n\nPlease review the attached document for our Q4 goals.\n\nBest,\nManager',
                    attachments: [
                        { attachment_id: 'a1', file_name: 'goals.pdf', file_size: '2.5MB' },
                        { attachment_id: 'a2', file_name: 'budget.xlsx', file_size: '1.2MB' }
                    ]
                });
            }
        } catch (err) {
            setError('Failed to load email details');
        } finally {
            setLoading(false);
        }
    };

    if (loading) {
        return (
            <div className="flex justify-center items-center h-64">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
            </div>
        );
    }

    if (error || !email) {
        return (
            <div className="text-center p-8">
                <div className="text-red-500 mb-4">{error || 'Email not found'}</div>
                <Link href="/dashboard/email" className="text-indigo-600 hover:underline">
                    Back to Inbox
                </Link>
            </div>
        );
    }

    return (
        <div className="bg-white dark:bg-zinc-900 shadow rounded-lg overflow-hidden min-h-[500px] flex flex-col">
            {/* Email Header */}
            <div className="p-6 border-b border-gray-200 dark:border-zinc-800">
                <div className="flex justify-between items-start mb-4">
                    <h1 className="text-2xl font-bold text-gray-900 dark:text-white">{email.subject}</h1>
                    <div className="flex gap-2">
                        <Link href="/dashboard/email" className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-zinc-800 dark:hover:bg-zinc-700 rounded text-gray-700 dark:text-gray-300 transition-colors">
                            &larr; Back
                        </Link>
                    </div>
                </div>
                <div className="flex items-center justify-between text-sm">
                    <div className="flex flex-col gap-1">
                        <p>
                            <span className="text-gray-500 dark:text-gray-400">From:</span>{' '}
                            <span className="font-semibold text-gray-900 dark:text-white">{email.sender_name || email.sender} <span className="text-gray-400 font-normal">&lt;{email.sender}&gt;</span></span>
                        </p>
                        <p>
                            <span className="text-gray-500 dark:text-gray-400">To:</span>{' '}
                            <span className="text-gray-900 dark:text-white">{email.receiver}</span>
                        </p>
                    </div>
                    <div className="text-gray-500 dark:text-gray-400">
                        {new Date(email.received_datetime).toLocaleString()}
                    </div>
                </div>
            </div>

            {/* Email Body */}
            <div className="p-6 flex-1 overflow-y-auto whitespace-pre-wrap text-gray-800 dark:text-gray-200 leading-relaxed font-sans">
                {email.body}
            </div>

            {/* Attachments */}
            {email.attachments && email.attachments.length > 0 && (
                <div className="p-6 bg-gray-50 dark:bg-zinc-900/50 border-t border-gray-200 dark:border-zinc-800">
                    <h3 className="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-3 uppercase tracking-wider">
                        Attachments ({email.attachments.length})
                    </h3>
                    <ul className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {email.attachments.map((att) => (
                            <li key={att.attachment_id} className="flex items-center justify-between p-3 bg-white dark:bg-zinc-800 border dark:border-zinc-700 rounded-lg shadow-sm">
                                <div className="flex items-center gap-3 overflow-hidden">
                                    <span className="text-2xl">üìÑ</span>
                                    <div className="min-w-0">
                                        <p className="text-sm font-medium text-gray-900 dark:text-white truncate" title={att.file_name}>
                                            {att.file_name}
                                        </p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400">
                                            {att.file_size}
                                        </p>
                                    </div>
                                </div>
                                <a
                                    href={api.getAttachmentDownloadUrl(email.id, att.attachment_id)}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="ml-2 text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 scroll-smooth"
                                >
                                    ‚¨áÔ∏è
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            )}
        </div>
    );
}
